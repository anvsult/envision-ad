@startuml

title <u>Design Level Sequence Diagram</u>\nHandle Checkout Session Completed (Webhook)


participant "<<utility>>\nlogger\n:Logger" as Logger
participant "<<control>>\nwebhookController\n:WebhookController" as Controller
participant "<<utility>>\nwebhook\n:com.stripe.net.Webhook" as StripeUtil
participant "<<control>>\nstripeWebhookService\n:StripeWebhookService" as Service

participant "<<repository>>\npaymentIntentRepository\n:PaymentIntentRepository" as PaymentRepo
participant "<<entity>>\npaymentIntent\n:PaymentIntent" as Payment

participant "<<repository>>\nreservationRepository\n:ReservationRepository" as ReservationRepo
participant "<<entity>>\nreservation\n:Reservation" as Reservation

participant "<<repository>>\nmediaRepository\n:MediaRepository" as MediaRepo
participant "<<repository>>\nadCampaignRepository\n:AdCampaignRepository" as CampaignRepo
participant "<<repository>>\nemployeeRepository\n:EmployeeRepository" as EmployeeRepo

participant "<<control>>\nadCampaignService\n:AdCampaignService" as CampaignService
participant "<<control>>\nemailService\n:EmailService" as EmailService

database "<<database>>\n:Database" as DB
actor "<<external>>\nStripe API" as StripeAPI
participant "<<external>>\nGmail SMTP" as GmailAPI
actor "Media Owner" as MediaOwner


StripeAPI -> Controller: POST /api/v1/stripe/webhook\n(Event: checkout.session.completed)
activate Controller

Controller -> StripeUtil: constructEvent(payload, signature, secret)
StripeUtil --> Controller: event

alt Event is checkout.session.completed

    Controller -> Service: handleCheckoutSessionCompleted(event)
    activate Service

    alt event data is invalid
        Service --> Logger: log error()
    else event data is valid

    Service -> PaymentRepo: findByStripeSessionId(sessionId)
    activate PaymentRepo
    PaymentRepo -> DB: SELECT paymentIntent where stripeSessionId = sessionId
    activate DB
    DB --> PaymentRepo: paymentIntent data
    deactivate DB
    PaymentRepo --> Service: paymentIntent: PaymentIntent
    deactivate PaymentRepo

    alt paymentIntent not found
        Service --> Logger: log error()
    else paymentIntent found

    Service -> Payment: setStripePaymentIntentId(...)
    note left
        Updating details of the retrieved
        payment intent to reflect successful payment.
    end note
    Service -> Payment: setStatus(SUCCEEDED)
    Service -> Payment: setUpdatedAt(LocalDateTime.now())


    Service -> PaymentRepo: save(paymentIntent)
    activate PaymentRepo
    PaymentRepo -> DB: UPDATE paymentIntent
    activate DB
    DB --> PaymentRepo: updatedPaymentIntent data
    deactivate DB
    PaymentRepo --> Service: savedPaymentIntent: PaymentIntent
    deactivate PaymentRepo

'    Service -> Service: updateReservationStatus(reservationId, ReservationStatus.CONFIRMED)
'    activate Service
'    note left of Service #aqua
'      The following sequence details the logic
'      inside the 'updateReservationStatus' method.
'    end note




    Service -> ReservationRepo: findByReservationId(reservationId)
    activate ReservationRepo
    ReservationRepo -> DB: SELECT reservation where reservation_id = reservationId
    activate DB
    DB --> ReservationRepo: reservation data
    deactivate DB
    ReservationRepo --> Service: reservation: Reservation
    deactivate ReservationRepo

    alt reservation not found
        Service --> Logger: log error()
    else reservation found

    Service -> Reservation: setStatus(CONFIRMED)

    note left
      Setting the reservation status
      of the retrieved reservation to
      CONFIRMED after successful payment.
    end note

    Service -> ReservationRepo: save(reservation)
    activate ReservationRepo
    ReservationRepo -> DB: UPDATE reservation where reservation_id = reservationId
    activate DB
    DB --> ReservationRepo
    deactivate DB
    ReservationRepo --> Service: savedReservation
    deactivate ReservationRepo

    Service -> MediaRepo: findById(mediaId)
    activate MediaRepo
    MediaRepo -> DB: SELECT media where media_id = mediaId
    activate DB
    DB --> MediaRepo: media data
    deactivate DB
    MediaRepo --> Service: media
    deactivate MediaRepo

    alt media not found
        Service --> Logger: log error()
    else media found

    Service -> CampaignRepo: findByCampaignId(campaignId)
    activate CampaignRepo
    CampaignRepo -> DB: SELECT adCampaign where campaign_id = campaignId
    activate DB
    DB --> CampaignRepo: adCampaign data
    deactivate DB
    CampaignRepo --> Service: adCampaign
    deactivate CampaignRepo

    alt ad campaign not found
        Service --> Logger: log error()
    else ad campaign found

    Service -> EmployeeRepo: findAllByBusinessId(businessId)
    activate EmployeeRepo
    EmployeeRepo -> DB: SELECT employees where business_id = businessId
    activate DB
    DB --> EmployeeRepo
    deactivate DB
    EmployeeRepo --> Service: mediaOwnerEmails
    deactivate EmployeeRepo

    alt no media owner emails found
        Service --> Logger: log error()
    else media owner emails found

    loop for each mediaOwnerEmail

        Service -> CampaignService: getAllCampaignImageLinks(campaignId)
        activate CampaignService
        CampaignService --> Service: imageLinks
        deactivate CampaignService

        Service -> EmailService: sendSimpleEmail(ownerEmail, subject, emailBody)
        note left
            Email body includes campaign
            details and image links.
        end note
        activate EmailService
        EmailService -> GmailAPI: SendSimpleEmail(to, subject, body)
        activate GmailAPI
        GmailAPI -> MediaOwner: emailNotification
        deactivate GmailAPI
        deactivate EmailService
'        deactivate Service
    end loop
    Service --> Controller: void
    deactivate Service

    Controller --> StripeAPI: HTTP 200 OK

    end alt
    end alt
    end alt
    end alt
    end alt
    end alt


end

deactivate Controller

@enduml
