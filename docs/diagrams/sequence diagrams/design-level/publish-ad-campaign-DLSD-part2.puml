@startuml
title <u>Design Level Sequence Diagram</u>\nPublish Ad Campaign (part 2)

actor "Media Owner" as MediaOwner
ref over MediaOwner
    <i>Media Owner reviews pending
    <i>reservation and approves it</i>
    <i>(Manage Reservation Use Case)</i>
end ref
actor Advertiser

participant "<<UI>>\nAdvertisements Page" as AdvertisementsPage
participant "<<UI>>\nPaymentModal" as PaymentModal
participant "<<UI>>\nEmbeddedCheckoutProvider" as EmbeddedCheckoutProvider
participant "<<UI>>\nEmbeddedCheckout" as EmbeddedCheckout
participant "<<control>>\npaymentController\n:PaymentController" as PaymentController
participant "<<control>>\nstripeService\n:StripeService" as StripeService
participant "<<repository>>\nadCampaignRepository\n:AdCampaignRepository" as CampaignRepo
participant "<<utility>>\njwtUtils\n:JwtUtils" as JwtUtils
participant "<<repository>>\nmediaRepository\n:MediaRepository" as MediaRepo
participant "<<repository>>\nstripeAccountRepository\n:StripeAccountRepository" as StripeAccountRepo
participant "<<repository>>\npaymentIntentRepository\n:PaymentIntentRepository" as PaymentIntentRepo
participant "<<external>>\nStripe API" as StripeAPI
database "<<database>>\n:Database" as DB


Advertiser -> AdvertisementsPage: Initiate Payment
activate AdvertisementsPage

AdvertisementsPage -> PaymentModal: PaymentModal()
activate PaymentModal

PaymentModal -> PaymentController: POST /api/v1/payments/create-payment-intent\ncreatePaymentIntent(reservationId, mediaId, campaignId, startDate, endDate)
activate PaymentController

PaymentController -> StripeService: createAuthorizedCheckoutSession(jwt, campaignId, mediaId, reservationId, startDate, endDate)
activate StripeService

StripeService -> CampaignRepo: findByCampaignId_CampaignId(campaignId)
activate CampaignRepo

CampaignRepo -> DB: SELECT * FROM ad_campaigns WHERE campaign_id = campaignId
activate DB
DB --> CampaignRepo: campaign
deactivate DB
CampaignRepo --> StripeService: campaign
deactivate CampaignRepo

' Validate that the user owns the campaign
StripeService -> JwtUtils: validateUserIsEmployeeOfBusiness(jwt, advertiserBusinessId)
note left
    Validating whether the advertiser's
    organization owns the campaign
end note
activate JwtUtils
JwtUtils --> StripeService: void (throws exception if validation fails)
deactivate JwtUtils

StripeService -> MediaRepo: findById(UUID.fromString(mediaId))
activate MediaRepo
MediaRepo -> DB: SELECT * FROM media WHERE media_id = mediaId
activate DB
DB --> MediaRepo: media
deactivate DB
MediaRepo --> StripeService: media
deactivate MediaRepo

StripeService -> StripeService: calculatePriceFromDates(mediaPrice, startDate, endDate)

' The call to createCheckoutSession is now detailed below
StripeService -> StripeService: createCheckoutSession(reservationId, calculatedAmount, mediaOwnerBusinessId)
'activate StripeService
'note left of StripeService #aqua
'  The following sequence details the logic
'  inside the 'createCheckoutSession' method.
'end note

StripeService -> PaymentIntentRepo: findByReservationId(reservationId)
activate PaymentIntentRepo
note right: Check if a payment has already been made
PaymentIntentRepo -> DB: SELECT * FROM payment_intents WHERE reservation_id = reservationId
activate DB
DB --> PaymentIntentRepo: existingPayment
deactivate DB
PaymentIntentRepo --> StripeService: existingPayment (Optional)
deactivate PaymentIntentRepo

'opt if payment has already succeeded
'    StripeService -> StripeService: throw new DuplicatePaymentException()
'end

StripeService -> StripeAccountRepo: findByBusinessId(businessId)
activate StripeAccountRepo
note right: Find media owner's Stripe account
StripeAccountRepo -> DB: SELECT * FROM stripe_accounts WHERE business_id = businessId
activate DB
DB --> StripeAccountRepo: stripeAccount
deactivate DB
StripeAccountRepo --> StripeService: stripeAccount
deactivate StripeAccountRepo

'opt if account not found or onboarding incomplete
'    StripeService -> StripeService: throw new StripeAccountNotFoundException()
'end

note left of StripeService
    - Convert amount to cents
    - Calculate platform fee
    - Create Idempotency Key
end note

StripeService -> StripeAPI: Session.create(SessionCreateParams)
note right: Create checkout session with transfer data and platform fee
activate StripeAPI
StripeAPI --> StripeService: session
deactivate StripeAPI

StripeService -> PaymentIntentRepo: save(paymentIntent)
note left: Create or update local payment record with PENDING status
activate PaymentIntentRepo
PaymentIntentRepo -> DB: INSERT/UPDATE payment_intent
activate DB
DB --> PaymentIntentRepo: void
deactivate DB
PaymentIntentRepo --> StripeService: savedPaymentIntent
deactivate PaymentIntentRepo

'deactivate StripeService
StripeService --> PaymentController: result: Map<String, String>
note left
    The result map includes the session_id
    and the client_secret from the payment intent,
    which is needed by the frontend to complete the payment.
    This information is safe to share with the client.
end note
deactivate StripeService

PaymentController --> PaymentModal: ResponseEntity.ok(result)
deactivate PaymentController

PaymentModal -> EmbeddedCheckoutProvider: EmbeddedCheckoutProvider(stripePromise, options)
activate EmbeddedCheckoutProvider
note left
    The EmbeddedCheckoutProvider
    is a UI component provided by
    Stripe that renders the payment
    form and handles the payment.
    Options argument includes the client
    secret from the payment intent
    and an onComplete callback function
end note

EmbeddedCheckoutProvider -> EmbeddedCheckout: EmbeddedCheckout()
activate EmbeddedCheckout
note left
    The EmbeddedCheckout component is
    responsible the payment form and
    handling user interactions.
    It uses the Stripe.js library
    to securely handle payment information
    and communicate with Stripe's servers.
end note


Advertiser -> EmbeddedCheckout: Enter Payment Details and submit

EmbeddedCheckout -> StripeAPI: confirmPayment(clientSecret, paymentDetails)
activate StripeAPI
StripeAPI --> EmbeddedCheckout: PaymentIntent
deactivate StripeAPI

EmbeddedCheckout --> PaymentModal: onComplete()
deactivate EmbeddedCheckout
deactivate EmbeddedCheckoutProvider
PaymentModal --> AdvertisementsPage: Payment Successful
deactivate PaymentModal
deactivate AdvertisementsPage

@enduml
