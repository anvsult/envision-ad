@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/devicons/java.puml

allowmixing
SetDefaultLegendEntries("")

!theme plain
hide empty methods

!procedure $table($name, $slug)
entity "<b>$name</b>" as $slug << (T, Orange) table >>
!endprocedure

!procedure $pk($name)
<color:#GoldenRod><&key></color> <b>$name</b>
!endprocedure

!procedure $fk($name)
<color:#Silver><&key></color> $name
!endprocedure

!procedure $column($name)
{field} $name
!endprocedure

database "PostgreSQL Database" as Database #336791 {
    $table("Organization", "organization_tb") {
        $pk("id"): SERIAL
        ---
        $column("organization_id"): VARCHAR(36) UNIQUE NOT NULL
        $column("name"): VARCHAR(255) NOT NULL
        $column("organization_size"): VARCHAR(50) NOT NULL
        $column("date_created"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        $column("owner_id"): VARCHAR(36)
        $column("media_owner"): BOOLEAN
        $column("advertiser"): BOOLEAN
        $column("verified"): BOOLEAN DEFAULT FALSE
        $column("street"): VARCHAR(255) NOT NULL
        $column("city"): VARCHAR(255) NOT NULL
        $column("state"): VARCHAR(255) NOT NULL
        $column("zip_code"): VARCHAR(255) NOT NULL
        $column("country"): VARCHAR(255) NOT NULL
    }

    $table("Verification", "verification_tb") {
        $pk("id"): SERIAL
        ---
        $column("verification_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("organization_id"): VARCHAR(36) NOT NULL
        ---
        $column("status"): VARCHAR(8) NOT NULL DEFAULT 'PENDING'
        $column("comments"): VARCHAR(512)
        $column("date_created"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        $column("date_modified"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    }

    $table("Employee", "employee_tb") {
        $pk("id"): SERIAL
        ---
        $column("employee_id"): VARCHAR(36) UNIQUE NOT NULL
        $column("user_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("organization_id"): VARCHAR(36) NOT NULL
        ---
        $column("email"): VARCHAR(255)
    }

    $table("Invitation", "invitation_tb") {
        $pk("id"): SERIAL
        ---
        $column("invitation_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("organization_id"): VARCHAR(36) NOT NULL
        ---
        $column("email"): VARCHAR(255) NOT NULL
        $column("token"): VARCHAR(100) NOT NULL
        $column("time_created"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        $column("time_expires"): TIMESTAMP
    }

    $table("Media Location", "media_location_tb") {
        $pk("media_location_id"): UUID DEFAULT gen_random_uuid()
        ---
        $column("name"): VARCHAR(255) NOT NULL
        $fk("organization_id"): UUID NOT NULL
        ---
        $column("country"): VARCHAR(100) NOT NULL
        $column("province"): VARCHAR(100) NOT NULL
        $column("city"): VARCHAR(100) NOT NULL
        $column("street"): VARCHAR(255) NOT NULL
        $column("postal_code"): VARCHAR(20) NOT NULL
        $column("latitude"): DOUBLE PRECISION NOT NULL
        $column("longitude"): DOUBLE PRECISION NOT NULL
        $column("geocoding_response"): TEXT
    }

    $table("Media", "media_tb") {
        $pk("media_id"): UUID DEFAULT gen_random_uuid()
        ---
        $fk("media_location_id"): UUID NOT NULL
        $fk("organization_id"): UUID
        ---
        $column("title"): VARCHAR(255) NOT NULL
        $column("media_owner_name"): VARCHAR(255) NOT NULL
        $column("type_of_display"): VARCHAR(50) NOT NULL
        $column("loop_duration"): INTEGER
        $column("resolution"): VARCHAR(50)
        $column("aspect_ratio"): VARCHAR(20)
        $column("width"): DOUBLE PRECISION
        $column("height"): DOUBLE PRECISION
        $column("price"): DECIMAL(10, 2)
        $column("daily_impressions"): INTEGER
        $column("schedule"): JSONB
        $column("status"): VARCHAR(50) NOT NULL
        $column("image_url"): VARCHAR(2048)
        $column("image_file_name"): VARCHAR(512)
        $column("image_content_type"): VARCHAR(100)
        $column("image_data"): BYTEA
        $column("preview_configuration"): JSONB
    }

    $table("Ad Campaigns", "ad_campaigns_tb") {
        $pk("id"): SERIAL
        ---
        $column("campaign_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("organization_id"): VARCHAR(36) NOT NULL
        ---
        $column("name"): VARCHAR(255) NOT NULL
    }

    $table("Ads", "ads_tb") {
        $pk("id"): SERIAL
        ---
        $column("ad_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("ad_campaign_ref_id"): INTEGER
        ---
        $column("name"): VARCHAR(255) NOT NULL
        $column("ad_url"): VARCHAR(512) NOT NULL
        $column("ad_duration_seconds"): INTEGER NOT NULL
        $column("ad_type"): VARCHAR(50) NOT NULL
    }

    $table("Reservations", "reservations_tb") {
        $pk("id"): SERIAL
        ---
        $column("reservation_id"): VARCHAR(36) UNIQUE NOT NULL
        $fk("campaign_id"): VARCHAR(36)
        $fk("media_id"): UUID
        ---
        $column("start_date"): TIMESTAMP
        $column("end_date"): TIMESTAMP
        $column("status"): VARCHAR(50) NOT NULL
        $column("reason"): VARCHAR(50)
        $column("description"): VARCHAR(512)
        $column("total_price"): DECIMAL(10, 2)
        $column("created_at"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        $column("advertiser_id"): VARCHAR(36)
    }

    $table("Stripe Accounts", "stripe_accounts_tb") {
        $pk("id"): BIGSERIAL
        ---
        $fk("organization_id"): VARCHAR(36) UNIQUE NOT NULL
        ---
        $column("stripe_account_id"): VARCHAR(255) UNIQUE NOT NULL
        $column("onboarding_complete"): BOOLEAN DEFAULT FALSE
        $column("charges_enabled"): BOOLEAN DEFAULT FALSE
        $column("payouts_enabled"): BOOLEAN DEFAULT FALSE
    }

    $table("Payment Intents", "payment_intents_tb") {
        $pk("id"): BIGSERIAL
        ---
        $fk("organization_id"): VARCHAR(36) NOT NULL
        ---
        $column("stripe_payment_intent_id"): VARCHAR(255) UNIQUE
        $column("stripe_session_id"): VARCHAR(255) UNIQUE
        $column("reservation_id"): VARCHAR(36) UNIQUE
        $column("amount"): DECIMAL(10, 2) NOT NULL
        $column("currency"): VARCHAR(3) DEFAULT 'CAD'
        $column("status"): VARCHAR(20) NOT NULL
        $column("created_at"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        $column("updated_at"): TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    }

    ' Relationships - showing all foreign key constraints
    verification_tb }o--|| organization_tb : "FK: organization_id"
    employee_tb }o--|| organization_tb : "FK: organization_id"
    invitation_tb }o--|| organization_tb : "FK: organization_id"

    media_location_tb }o--|| organization_tb : "FK: organization_id"
    media_tb }o--|| media_location_tb : "FK: media_location_id"
    media_tb }o--o| organization_tb : "FK: organization_id"

    ad_campaigns_tb }o--|| organization_tb : "FK: organization_id"
    ads_tb }o--o| ad_campaigns_tb : "FK: ad_campaign_ref_id"

    reservations_tb }o--o| ad_campaigns_tb : "FK: campaign_id"
    reservations_tb }o--o| media_tb : "FK: media_id"

    stripe_accounts_tb ||--|| organization_tb : "FK: organization_id"
    payment_intents_tb }o--|| organization_tb : "FK: organization_id"
}

AddElementTag("service", $shape=EightSidedShape(), $bgColor="Green", $fontColor="white", $legendText="API \neight sided")

Container(api, "API", "REST API", "API for the Envision Ad System.", $sprite="java", $tags="service")

api --> Database : **SQL/TCP** \n[JDBC]
@enduml